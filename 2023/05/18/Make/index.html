<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"><title>Make | FreChen026</title><meta name="keywords" content="工具,Linux"><meta name="author" content="FreChen026"><meta name="copyright" content="FreChen026"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="ffffff"><meta name="description" content="前言：前段时间写OS的Lab2时，就已经使用了Makefile，不过较为简单，也只是一知半解。(不过前段时间听他们群里的说法Makefile也是旧日荣光了？)   概述为什么要有Makefile？应对大型工程项目，makefile可以定义了整个编译流程以及各个目标文件与源文件之间的依赖关系，出现修改时，只会重新编译修改会影响的部分，从而降低了编译的时间，提升了编译的效率。 Makefile究竟是什">
<meta property="og:type" content="article">
<meta property="og:title" content="Make">
<meta property="og:url" content="http://example.com/2023/05/18/Make/index.html">
<meta property="og:site_name" content="FreChen026">
<meta property="og:description" content="前言：前段时间写OS的Lab2时，就已经使用了Makefile，不过较为简单，也只是一知半解。(不过前段时间听他们群里的说法Makefile也是旧日荣光了？)   概述为什么要有Makefile？应对大型工程项目，makefile可以定义了整个编译流程以及各个目标文件与源文件之间的依赖关系，出现修改时，只会重新编译修改会影响的部分，从而降低了编译的时间，提升了编译的效率。 Makefile究竟是什">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://s2.loli.net/2023/05/18/r9XmfvjieSY4VK2.jpg">
<meta property="article:published_time" content="2023-05-18T03:25:54.000Z">
<meta property="article:modified_time" content="2023-05-18T03:30:56.180Z">
<meta property="article:author" content="FreChen026">
<meta property="article:tag" content="工具">
<meta property="article:tag" content="Linux">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://s2.loli.net/2023/05/18/r9XmfvjieSY4VK2.jpg"><link rel="shortcut icon" href="https://s2.loli.net/2023/03/10/eRLkCVOgloy9Y43.jpg"><link rel="canonical" href="http://example.com/2023/05/18/Make/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":false,"languages":{"hits_empty":"找不到您查询的内容：${query}"}},
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '天',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: true,
  isAnchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'Make',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2023-05-18 11:30:56'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', 'ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><meta name="generator" content="Hexo 6.3.0"></head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s2.loli.net/2023/03/10/yFU1XmJBxQcCoz6.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">22</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">22</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">12</div></a></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> 生活</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/photos/"><i class="fa-fw fas fa-camera"></i><span> 相册</span></a></li><li><a class="site-page child" href="/movies/"><i class="fa-fw fas fa-video"></i><span> 视频</span></a></li><li><a class="site-page child" href="/music/"><i class="fa-fw fas fa-music"></i><span> 音乐</span></a></li></ul></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('https://s2.loli.net/2023/05/18/r9XmfvjieSY4VK2.jpg')"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">FreChen026</a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> 生活</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/photos/"><i class="fa-fw fas fa-camera"></i><span> 相册</span></a></li><li><a class="site-page child" href="/movies/"><i class="fa-fw fas fa-video"></i><span> 视频</span></a></li><li><a class="site-page child" href="/music/"><i class="fa-fw fas fa-music"></i><span> 音乐</span></a></li></ul></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">Make</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2023-05-18T03:25:54.000Z" title="发表于 2023-05-18 11:25:54">2023-05-18</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2023-05-18T03:30:56.180Z" title="更新于 2023-05-18 11:30:56">2023-05-18</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E5%B7%A5%E5%85%B7/">工具</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字数总计:</span><span class="word-count">2.6k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>9分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="Make"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><div class="note info simple"><p>前言：前段时间写OS的Lab2时，就已经使用了<code>Makefile</code>，不过较为简单，也只是一知半解。(不过前段时间听他们群里的说法<code>Makefile</code>也是旧日荣光了？)</p>
</div>

<h1 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h1><h2 id="为什么要有Makefile？"><a href="#为什么要有Makefile？" class="headerlink" title="为什么要有Makefile？"></a>为什么要有<code>Makefile</code>？</h2><p>应对大型工程项目，<code>makefile</code>可以定义了整个编译流程以及各个目标文件与源文件之间的依赖关系，出现修改时，只会重新编译修改会影响的部分，从而降低了编译的时间，提升了编译的效率。</p>
<h2 id="Makefile究竟是什么？"><a href="#Makefile究竟是什么？" class="headerlink" title="Makefile究竟是什么？"></a><code>Makefile</code>究竟是什么？</h2><p><code>Makefile</code>是整个工程的编译原则，定义了一系列的规则来指定文件编译顺序</p>
<p><code>Makefile</code>给工程带来了“自动化编译”，一个<code>make</code>指令就可以使整个工程完全自动编译</p>
<h2 id="区分GNU-Make和Makefile"><a href="#区分GNU-Make和Makefile" class="headerlink" title="区分GNU Make和Makefile"></a>区分<code>GNU Make</code>和<code>Makefile</code></h2><p><code>GNU Make is a tool which controls the generation of executables and other non-source files of a program from the program&#39;s source files.</code></p>
<p><code>Make gets its knowledge of how to build your program from a file called the makefile, which lists each of the non-source files and how to compute it from other files.</code></p>
<p>上述是来自于<code>GNU</code>官网对于两者的定义，可以直观看出，<code>Make</code>是批处理的工具，而这个工具所仰仗的信息来源于<code>Makefile</code>，所以写好<code>Makefile</code>文件使我们能很好利用<code>Make</code>工具的重要前提。</p>
<h1 id="写Makefile"><a href="#写Makefile" class="headerlink" title="写Makefile"></a>写<code>Makefile</code></h1><h2 id="基本规则"><a href="#基本规则" class="headerlink" title="基本规则"></a>基本规则</h2><p>1.如果这个工程没有编译过，那么我们的所有c文件都要编译并被链接。<br>2.如果这个工程的某几个c文件被修改，那么我们只编译被修改的c文件，并链接目标程序。<br>3.如果这个工程的头文件被改变了，那么我们需要编译引用了这几个头文件的c文件，并链接目标程序。</p>
<p>默认情况下，<code>make</code>命令会在当前目录下按顺序寻找文件名为<code>GNUmakefile</code>、<code>makefile</code>、<code>Makefile</code>的文件，最好使用<code>Makefile</code>这个文件名，最好不要用<code>GNUmakefile</code>，因为这个文件只能由<code>GNU</code>去<code>make</code>。当然也可以使用别的文件名来书写<code>makefile</code>，不过需要加上<code>-f</code>可选项进行指定。</p>
<h2 id="基本格式"><a href="#基本格式" class="headerlink" title="基本格式"></a>基本格式</h2><figure class="highlight makefile"><table><tr><td class="code"><pre><span class="line"><span class="section">target: prerequisites</span></span><br><span class="line">    recipe</span><br><span class="line">    ...</span><br><span class="line">    ...</span><br></pre></td></tr></table></figure>

<p>结合上述基本规则，<code>Makefile</code>最核心的内容就是<code>prerequisites</code>中如果有一个以上的文件比<code>target</code>文件要新的话，<code>recipe</code>所定义的命令就会被执行。</p>
<h3 id="target"><a href="#target" class="headerlink" title="target"></a>target</h3><p>可以是<code>object file</code>，也可以是一个可执行文件，还可以是一个标签</p>
<h3 id="prerequisites"><a href="#prerequisites" class="headerlink" title="prerequisites"></a>prerequisites</h3><p>生成该<code>target</code>所要依赖的文件或其他<code>target</code></p>
<h3 id="recipe"><a href="#recipe" class="headerlink" title="recipe"></a>recipe</h3><p>该<code>target</code>要执行的命令，每行一定要以<code>Tab</code>开头</p>
<h2 id="工作流程"><a href="#工作流程" class="headerlink" title="工作流程"></a>工作流程</h2><figure class="highlight makefile"><table><tr><td class="code"><pre><span class="line"><span class="section">main: a.o b.o</span></span><br><span class="line">	gcc -o main a.o b.o</span><br><span class="line"></span><br><span class="line"><span class="section">a.o: a.c</span></span><br><span class="line">	gcc -c a.c -o a.o</span><br><span class="line"></span><br><span class="line"><span class="section">b.o: b.c</span></span><br><span class="line">	gcc -c b.c -o b.o</span><br><span class="line"></span><br><span class="line"><span class="section">clean:</span></span><br><span class="line">	rm -rf a.o b.o main</span><br></pre></td></tr></table></figure>
<p>使用上述<code>makefile</code>文件，目录结构为</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">a.c  b.c  makefile</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">frechen026@frechen026-virtual-machine:~/Desktop/MakeTest$ make</span><br><span class="line">gcc -c a.c -o a.o</span><br><span class="line">gcc -c b.c -o b.o</span><br><span class="line">gcc -o main a.o b.o</span><br><span class="line">frechen026@frechen026-virtual-machine:~/Desktop/MakeTest$ ./main</span><br><span class="line">hello, a!</span><br><span class="line">hello, b!!</span><br><span class="line">frechen026@frechen026-virtual-machine:~/Desktop/MakeTest$ make</span><br><span class="line">gcc -c b.c -o b.o</span><br><span class="line">gcc -o main a.o b.o</span><br><span class="line">frechen026@frechen026-virtual-machine:~/Desktop/MakeTest$ ./main</span><br><span class="line">hello, a!</span><br><span class="line">hello, b!</span><br><span class="line">frechen026@frechen026-virtual-machine:~/Desktop/MakeTest$ make</span><br><span class="line">make: &#x27;main&#x27; is up to date.</span><br><span class="line">frechen026@frechen026-virtual-machine:~/Desktop/MakeTest$ ./main</span><br><span class="line">hello, a!</span><br><span class="line">hello, b!</span><br></pre></td></tr></table></figure>

<p>使用<code>make</code>指令可以看出执行了<code>main</code>这个<code>target</code>的内容，对<code>b.c</code>文件进行修改，发现只执行了<code>gcc -c b.c -o b.o</code>，未执行<code>gcc -c a.c -o a.o</code>，在不进行修改的情况下执行<code>make</code>，发现提示已是最新，无需更新。</p>
<h3 id="make指令"><a href="#make指令" class="headerlink" title="make指令"></a><code>make</code>指令</h3><p>默认的指令便是<code>make</code>，我们不需要在<code>makefile</code>文件中显式的指出(似乎也没法指出，毕竟<code>target</code>不能是个空吧)</p>
<p><code>make</code>指令的工作流程：<br>1.找寻当前目录下<code>Makefile</code>文件<br>2.默认使用第一个<code>target</code>，找寻第一条<code>target</code>的依赖<br>3.处理依赖文件的<code>target</code><br>4.根据目标<code>target</code>修改时间以及依赖的修改时间判断是否需要重新构建</p>
<p>参考教程<a target="_blank" rel="noopener" href="https://seisman.github.io/how-to-write-makefile">跟我一起写Makefile</a>，这里的表述我认为是存在一定问题的，未先去处理依赖文件如何获知依赖文件的最后更新时间以及是否存在？时间逻辑的先后应该是先去递归处理依赖文件，最后才是返回来处理目标<code>target</code></p>
<p>官方的描述为：<br><code>In the example, this rule is for relinking edit; but before make can fully process this rule, it must process the rules for the files that edit depends on, which in this case are the object files. Each of these files is processed according to its own rule.</code></p>
<p>后续引入了其他<code>makefile</code>文件以及变量等概念后，<code>make</code>工作时的执行步骤为：<br>1.读入所有的Makefile<br>2.读入被include的其它Makefile<br>3.初始化文件中的变量<br>4.推导隐式规则，并分析所有规则<br>5.为所有的目标文件创建依赖关系链<br>6.根据依赖关系，决定哪些目标要重新生成<br>7.执行生成命令</p>
<h3 id="其他target指令"><a href="#其他target指令" class="headerlink" title="其他target指令"></a>其他<code>target</code>指令</h3><p><code>make</code>默认执行的就是第一个<code>target</code>以及其依赖的<code>target</code>，故无关联的<code>target</code>并不会进行执行，如我们所写<code>makefile</code>中的<code>clean</code>，但我们可以通过显式执行来执行<code>clean</code>，即<code>make clean</code>指令。</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">frechen026@frechen026-virtual-machine:~/Desktop/MakeTest$ make clean</span><br><span class="line">rm -rf a.o b.o main</span><br></pre></td></tr></table></figure>

<p>效果如上所示，故<code>make</code>指令也可以显式为<code>make</code>加上首条<code>target</code>，在此即为<code>make main</code>，效果如下所示</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">frechen026@frechen026-virtual-machine:~/Desktop/MakeTest$ make main</span><br><span class="line">gcc -c a.c -o a.o</span><br><span class="line">gcc -c b.c -o b.o</span><br><span class="line">gcc -o main a.o b.o</span><br></pre></td></tr></table></figure>

<p>因此我们可以通过显式方法来执行其余<code>target</code>，其余<code>target</code>的工作流程也与<code>make</code>相同。</p>
<p>不难发现，有些<code>target</code>如上述的<code>clean</code>，并非是文件名。我们可以使用虚假的目标<code>PHONY</code>，将目标标记为不指向文件，当然<code>PHONY</code>同样适用于文件。</p>
<p>语法格式:</p>
<figure class="highlight makefile"><table><tr><td class="code"><pre><span class="line"><span class="meta"><span class="keyword">.PHONY</span>: target1 target2 ...</span></span><br></pre></td></tr></table></figure>

<figure class="highlight makefile"><table><tr><td class="code"><pre><span class="line"><span class="section">main: a.o b.o</span></span><br><span class="line">	gcc -o main a.o b.o</span><br><span class="line"></span><br><span class="line"><span class="section">a.o: a.c</span></span><br><span class="line">	gcc -c a.c -o a.o</span><br><span class="line"></span><br><span class="line"><span class="section">b.o: b.c</span></span><br><span class="line">	gcc -c b.c -o b.o</span><br><span class="line"></span><br><span class="line"><span class="section">clean:</span></span><br><span class="line">	rm -rf a.o b.o main</span><br><span class="line"></span><br><span class="line"><span class="meta"><span class="keyword">.PHONY</span>: main clean</span></span><br></pre></td></tr></table></figure>

<p>值得注意的一点是：<code>PHONY</code>目标总是被认为是过期的，因此将总是运行这些<code>target</code>的<code>recipe</code>，递归的也将总是运行包含<code>PHONY</code>依赖的<code>target</code></p>
<p>还是上述的<code>makefile</code>，每次执行<code>make</code>，发现都会执行<code>main</code>下的<code>recipe</code></p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">frechen026@frechen026-virtual-machine:~/Desktop/MakeTest$ make</span><br><span class="line">gcc -o main a.o b.o</span><br><span class="line">frechen026@frechen026-virtual-machine:~/Desktop/MakeTest$ make</span><br><span class="line">gcc -o main a.o b.o</span><br></pre></td></tr></table></figure>

<p>将<code>a.o</code>置为<code>PHONY</code>，取消<code>main</code>的<code>PHONY</code>，执行<code>make</code></p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">frechen026@frechen026-virtual-machine:~/Desktop/MakeTest$ make</span><br><span class="line">gcc -c a.c -o a.o</span><br><span class="line">gcc -o main a.o b.o</span><br><span class="line">frechen026@frechen026-virtual-machine:~/Desktop/MakeTest$ make</span><br><span class="line">gcc -c a.c -o a.o</span><br><span class="line">gcc -o main a.o b.o</span><br></pre></td></tr></table></figure>

<p>由于<code>main</code>的依赖<code>target</code>是<code>PHONY</code>的，不仅是<code>a.o</code>需要重编译，<code>main</code>受其牵连也要如此。</p>
<h3 id="清空目录的规则"><a href="#清空目录的规则" class="headerlink" title="清空目录的规则"></a>清空目录的规则</h3><p>每个<code>Makefile</code>中都应该写一个清空目标文件（ .o ）和可执行文件的规则，这不仅便于重编译，也很利于保持文件的清洁。这是一个“修养”。</p>
<p>确实如此！</p>
<h3 id="question"><a href="#question" class="headerlink" title="question"></a>question</h3><p><del>一个令我感到头疼的问题是所谓目标<code>target</code>和依赖更新时间的先后，如果目标<code>target</code>是文件，那这不难理解，文件都有最后一次写入时间。但若是目标<code>target</code>根本就不是文件或是一个根本不存在的文件，类似于上述的伪目录</del></p>
<p>处处透露出合理，却在某些时候想不通真是一件让人难过的事。这两天虽然看了看<a target="_blank" rel="noopener" href="https://github.com/ryanhanwu/How-To-Ask-Questions-The-Smart-Way/blob/main/README-zh_CN.md">提问的智慧</a>，可当自己想描述一个问题时却发现还是十分困难，果然，提问是门艺术。</p>
<p>表述为不存在的文件或者伪目标应该都是“过期的”，而依赖也是在检测自己是否是“过期的”，如果过期则执行相关的重新编译。</p>
<h2 id="书写规范"><a href="#书写规范" class="headerlink" title="书写规范"></a>书写规范</h2><h3 id="变量使用"><a href="#变量使用" class="headerlink" title="变量使用"></a>变量使用</h3><p>将需要重复大段使用的内容整合为一个变量，便于修改以及复用</p>
<p>我们可以修改<code>makefile</code>文件，将<code>a.o b.o</code>列为变量</p>
<figure class="highlight makefile"><table><tr><td class="code"><pre><span class="line">objects = a.o b.o</span><br><span class="line"></span><br><span class="line"><span class="section">main: <span class="variable">$(objects)</span></span></span><br><span class="line">	gcc -o main a.o b.o</span><br><span class="line"></span><br><span class="line"><span class="section">a.o: a.c</span></span><br><span class="line">	gcc -c a.c -o a.o</span><br><span class="line"></span><br><span class="line"><span class="section">b.o: b.c</span></span><br><span class="line">	gcc -c b.c -o b.o</span><br><span class="line"></span><br><span class="line"><span class="section">clean:</span></span><br><span class="line">	rm -rf a.o b.o main</span><br><span class="line"></span><br><span class="line"><span class="meta"><span class="keyword">.PHONY</span>: clean</span></span><br></pre></td></tr></table></figure>

<p>执行效果一样。</p>
<p>在<code>makefile</code>中定义的变量，声明时要给予初值，而在使用时要在变量名前加上<code>$</code>，最好使用<code>()</code>或者<code>&#123;&#125;</code>将变量名括起来。</p>
<h3 id="隐式规则"><a href="#隐式规则" class="headerlink" title="隐式规则"></a>隐式规则</h3><p>是一种惯例，让<code>make</code>自己去推导会发生什么，这些约定俗成的内容在我们不显式指出并规定时就会按照默认进行。</p>
<p>可以将上述<code>makefile</code>进一步精简</p>
<figure class="highlight makefile"><table><tr><td class="code"><pre><span class="line">objects = a.o b.o</span><br><span class="line"></span><br><span class="line"><span class="section">main: <span class="variable">$(objects)</span></span></span><br><span class="line">	gcc -o main a.o b.o</span><br><span class="line"></span><br><span class="line"><span class="section">clean:</span></span><br><span class="line">	rm -rf a.o b.o main</span><br><span class="line"></span><br><span class="line"><span class="meta"><span class="keyword">.PHONY</span>: clean</span></span><br></pre></td></tr></table></figure>

<p>执行<code>make</code>指令发现</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">frechen026@frechen026-virtual-machine:~/Desktop/MakeTest$ make</span><br><span class="line">cc    -c -o a.o a.c</span><br><span class="line">cc    -c -o b.o b.c</span><br><span class="line">gcc -o main a.o b.o</span><br></pre></td></tr></table></figure>
<p><code>GNU Make</code>工具已经猜测出生成<code>a.o b.o</code>所需执行的指令</p>
<p>当然，还有很多隐式的一些规则，不加以罗列，但对于一些不是很清楚的隐式规则可能发生时，我们应该想方设法避免他，即使他真的十分简洁。</p>
<h3 id="注释"><a href="#注释" class="headerlink" title="注释"></a>注释</h3><p>写好注释应该是每个好的程序员应该有的素养，<code>makefile</code>也可以书写注释，其注释采用<code>#</code>，一般编辑器下应该都可以使用快捷键<code>ctrl + /</code></p>
<h3 id="伪目标"><a href="#伪目标" class="headerlink" title="伪目标"></a>伪目标</h3><p>上面已经提及过相关内容，“伪目标”并不是一个文件，只是一个标签而已。为了避免“伪标签”和文件重名的情况，我们可以使用特使标记<code>.PHONY</code>来显式的指明一个目标是“伪目标”。</p>
<p>伪目标一般没有依赖的文件。但是，我们也可以为伪目标指定所依赖的文件。伪目标同样可以作为“默认目标”，只要将其放在第一个。一个示例就是，如果你的<code>Makefile</code>需要一口气生成若干个可执行文件，但你只想简单地敲一个<code>make</code>完事，并且，所有的目标文件都写在一个<code>Makefile</code>中，那么你可以使用“伪目标”这个特性。</p>
<p>所以我们可以借助“伪目标”简化<code>shell</code>命令，以简单的语句执行复杂的<code>shell</code>语句，前提是你的<code>makefile</code>写的足够好。</p>
<h1 id="后话"><a href="#后话" class="headerlink" title="后话"></a>后话</h1><p>当然，<code>makefile</code>还有很多细节值得去学习，例如函数、多文件等等，不过总感觉记录下来过于繁琐，也可能是不知道如何记录。所以碰到实际的问题还是要多参考参考下面的几篇教程……</p>
<p>参考教程：<br><a target="_blank" rel="noopener" href="https://seisman.github.io/how-to-write-makefile">跟我一起写Makefile</a><br><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/392780283">GUN make 入门到精通</a><br><a target="_blank" rel="noopener" href="https://www.gnu.org/software/make/manual/make.html">GNU make</a></p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="http://example.com">FreChen026</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="http://example.com/2023/05/18/Make/">http://example.com/2023/05/18/Make/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://example.com" target="_blank">FreChen026</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/%E5%B7%A5%E5%85%B7/">工具</a><a class="post-meta__tags" href="/tags/Linux/">Linux</a></div><div class="post_share"><div class="social-share" data-image="https://s2.loli.net/2023/05/18/r9XmfvjieSY4VK2.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2023/05/21/OS/"><img class="prev-cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s2.loli.net/2023/05/21/exL2WY8ItFTJErP.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">OS</div></div></a></div><div class="next-post pull-right"><a href="/2023/05/08/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%A7%91%E5%AD%A6%E9%80%9F%E6%88%90/"><img class="next-cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s2.loli.net/2023/05/08/Mlk61s4GdPqgmKW.png" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">计算机科学速成</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><div><a href="/2023/05/24/Shell/" title="Shell"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s2.loli.net/2023/05/24/1gbqds2iAQU7FmM.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-05-24</div><div class="title">Shell</div></div></a></div><div><a href="/2023/03/24/Bochs%E5%AE%89%E8%A3%85/" title="Bochs安装"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s2.loli.net/2023/03/24/LJk7PeB9Yc3ZmQW.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-03-24</div><div class="title">Bochs安装</div></div></a></div><div><a href="/2023/03/16/Git/" title="Git"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s2.loli.net/2023/03/16/L7XzVTpDqGwPuW3.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-03-16</div><div class="title">Git</div></div></a></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s2.loli.net/2023/03/10/yFU1XmJBxQcCoz6.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">FreChen026</div><div class="author-info__description"></div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">22</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">22</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">12</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/FreChen026"><i class="fab fa-github"></i><span>认识我</span></a></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">这是我的Hexo博客，用于记录一些学习和生活方面的内容，欢迎交流！</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%A6%82%E8%BF%B0"><span class="toc-number">1.</span> <span class="toc-text">概述</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%BA%E4%BB%80%E4%B9%88%E8%A6%81%E6%9C%89Makefile%EF%BC%9F"><span class="toc-number">1.1.</span> <span class="toc-text">为什么要有Makefile？</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Makefile%E7%A9%B6%E7%AB%9F%E6%98%AF%E4%BB%80%E4%B9%88%EF%BC%9F"><span class="toc-number">1.2.</span> <span class="toc-text">Makefile究竟是什么？</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8C%BA%E5%88%86GNU-Make%E5%92%8CMakefile"><span class="toc-number">1.3.</span> <span class="toc-text">区分GNU Make和Makefile</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%86%99Makefile"><span class="toc-number">2.</span> <span class="toc-text">写Makefile</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9F%BA%E6%9C%AC%E8%A7%84%E5%88%99"><span class="toc-number">2.1.</span> <span class="toc-text">基本规则</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9F%BA%E6%9C%AC%E6%A0%BC%E5%BC%8F"><span class="toc-number">2.2.</span> <span class="toc-text">基本格式</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#target"><span class="toc-number">2.2.1.</span> <span class="toc-text">target</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#prerequisites"><span class="toc-number">2.2.2.</span> <span class="toc-text">prerequisites</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#recipe"><span class="toc-number">2.2.3.</span> <span class="toc-text">recipe</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%B7%A5%E4%BD%9C%E6%B5%81%E7%A8%8B"><span class="toc-number">2.3.</span> <span class="toc-text">工作流程</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#make%E6%8C%87%E4%BB%A4"><span class="toc-number">2.3.1.</span> <span class="toc-text">make指令</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%85%B6%E4%BB%96target%E6%8C%87%E4%BB%A4"><span class="toc-number">2.3.2.</span> <span class="toc-text">其他target指令</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B8%85%E7%A9%BA%E7%9B%AE%E5%BD%95%E7%9A%84%E8%A7%84%E5%88%99"><span class="toc-number">2.3.3.</span> <span class="toc-text">清空目录的规则</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#question"><span class="toc-number">2.3.4.</span> <span class="toc-text">question</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B9%A6%E5%86%99%E8%A7%84%E8%8C%83"><span class="toc-number">2.4.</span> <span class="toc-text">书写规范</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8F%98%E9%87%8F%E4%BD%BF%E7%94%A8"><span class="toc-number">2.4.1.</span> <span class="toc-text">变量使用</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%9A%90%E5%BC%8F%E8%A7%84%E5%88%99"><span class="toc-number">2.4.2.</span> <span class="toc-text">隐式规则</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B3%A8%E9%87%8A"><span class="toc-number">2.4.3.</span> <span class="toc-text">注释</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BC%AA%E7%9B%AE%E6%A0%87"><span class="toc-number">2.4.4.</span> <span class="toc-text">伪目标</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%90%8E%E8%AF%9D"><span class="toc-number">3.</span> <span class="toc-text">后话</span></a></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2023/05/28/%E4%B8%A4%E5%B9%B4%E5%89%8D%E5%9F%8B%E4%B8%8B%E7%9A%84%E9%9A%90%E6%82%A3/" title="两年前埋下的隐患"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s2.loli.net/2023/05/28/wMSNlG5nVbaOorH.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="两年前埋下的隐患"/></a><div class="content"><a class="title" href="/2023/05/28/%E4%B8%A4%E5%B9%B4%E5%89%8D%E5%9F%8B%E4%B8%8B%E7%9A%84%E9%9A%90%E6%82%A3/" title="两年前埋下的隐患">两年前埋下的隐患</a><time datetime="2023-05-28T10:37:03.000Z" title="发表于 2023-05-28 18:37:03">2023-05-28</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2023/05/24/Shell/" title="Shell"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s2.loli.net/2023/05/24/1gbqds2iAQU7FmM.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Shell"/></a><div class="content"><a class="title" href="/2023/05/24/Shell/" title="Shell">Shell</a><time datetime="2023-05-24T14:18:05.000Z" title="发表于 2023-05-24 22:18:05">2023-05-24</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2023/05/21/OS/" title="OS"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s2.loli.net/2023/05/21/exL2WY8ItFTJErP.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="OS"/></a><div class="content"><a class="title" href="/2023/05/21/OS/" title="OS">OS</a><time datetime="2023-05-21T15:10:29.000Z" title="发表于 2023-05-21 23:10:29">2023-05-21</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2023/05/18/Make/" title="Make"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s2.loli.net/2023/05/18/r9XmfvjieSY4VK2.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Make"/></a><div class="content"><a class="title" href="/2023/05/18/Make/" title="Make">Make</a><time datetime="2023-05-18T03:25:54.000Z" title="发表于 2023-05-18 11:25:54">2023-05-18</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2023/05/08/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%A7%91%E5%AD%A6%E9%80%9F%E6%88%90/" title="计算机科学速成"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s2.loli.net/2023/05/08/Mlk61s4GdPqgmKW.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="计算机科学速成"/></a><div class="content"><a class="title" href="/2023/05/08/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%A7%91%E5%AD%A6%E9%80%9F%E6%88%90/" title="计算机科学速成">计算机科学速成</a><time datetime="2023-05-08T15:10:02.000Z" title="发表于 2023-05-08 23:10:02">2023-05-08</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2023 By FreChen026</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="is-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  数据库加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div><hr/><div id="local-search-results"></div></div></div><div id="search-mask"></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.umd.min.js"></script><script src="https://cdn.jsdelivr.net/npm/vanilla-lazyload/dist/lazyload.iife.min.js"></script><script src="/js/search/local-search.js"></script><div class="js-pjax"></div><script defer="defer" id="fluttering_ribbon" mobile="false" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/canvas-fluttering-ribbon.min.js"></script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>